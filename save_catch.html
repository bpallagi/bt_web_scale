<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body {
        font-family: 'Arial', sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }
      .container {
        width: 100%;
        max-width: 450px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      h2 {
        text-align: center;
        color: #333;
      }
      input, button, select {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
      }
      button {
        background-color: #4CAF50;
        color: white;
        font-size: 16px;
        cursor: pointer;
      }
      button:hover {
        background-color: #45a049;
      }
      .message {
        margin-top: 20px;
        padding: 10px;
        border-radius: 8px;
        font-weight: bold;
        text-align: center;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
      }
      .icon {
        font-size: 24px;
        vertical-align: middle;
        margin-right: 5px;
      }
      .options-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .options-row label {
        display: flex;
        align-items: center;
        font-size: 14px;
      }
      .options-row input {
        width: auto;
        margin-right: 5px;
      }
      #tareWeightSelect {
        display: none;
        margin: 5px 0 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>üé£ Fog√°s r√∂gz√≠t√©se üê†</h2>
      <input type="text" id="chipNumber" placeholder="#Ô∏è‚É£ Chip sz√°m (6‚Äì15 karakter)" pattern=".{6,15}" title="A chip sz√°mnak legal√°bb 6, legfeljebb 15 karakteresnek kell lennie" required>
      <input type="number" id="fishWeight" placeholder="‚öñÔ∏è Hal s√∫lya (kg)" step="0.1" min="10">
      <input type="text" id="anglerName" placeholder="üë§ Horg√°sz neve">
      <input type="text" id="catchLocation" placeholder="üìç Fog√°s helye">
      <button type="button" onclick="connectBluetooth()">üì° Csatlakoz√°s a m√©rleghez</button>

      <div class="options-row">
        <label>
          <input type="checkbox" id="tareCheckbox">
          M√©rlegl≈ëzs√°k visszam√©r√©se
        </label>
      </div>
      <select id="tareWeightSelect"></select>
      <div>
        <button type="button" onclick="adjustWeight(-0.05)">‚ûñ 0.05 kg</button>
        <button type="button" onclick="adjustWeight(0.05)">‚ûï 0.05 kg</button>
      </div>
      <button id="saveButton" onclick="saveData()">üíæ Ment√©s</button>
      <div id="message"></div>
    </div>

    <script>
      let bluetoothDevice;
      let weightCharacteristic;
      
      async function connectBluetooth() {
        try {
          bluetoothDevice = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: 'WH-C06' }],
            optionalServices: [0xfff0]
          });
      
          const server = await bluetoothDevice.gatt.connect();
          const service = await server.getPrimaryService(0xfff0);
          weightCharacteristic = await service.getCharacteristic(0xfff1);
      
          await weightCharacteristic.startNotifications();
          weightCharacteristic.addEventListener('characteristicvaluechanged', handleBluetoothData);
      
          alert("‚úÖ Kapcsol√≥dva a m√©rleghez!");
        } catch (error) {
          console.error('Bluetooth hiba:', error);
          alert("‚ö†Ô∏è Nem siker√ºlt kapcsol√≥dni a m√©rleghez.");
        }
      }
      
      function handleBluetoothData(event) {
        const value = event.target.value;
        let data = [];
      
        for (let i = 0; i < value.byteLength; i++) {
          data.push(value.getUint8(i));
        }
      
        const weight = parseWeightData(data);
        if (!isNaN(weight)) {
          document.getElementById("Hal_Suly").value = weight.toFixed(2);
          updateSulyKulonbseg(); // ha van ilyen f√ºggv√©nyed, ami √∫jrasz√°molja a s√∫lyk√ºl√∂nbs√©get
        }
      }
      
      function parseWeightData(data) {
        // P√©ld√°ul: WH-C06 0xFF adatcsomag: [0xFF, 0x0B, 0xB8] = 3000 = 3.00kg
        if (data.length >= 3 && data[0] === 0xFF) {
          const raw = (data[1] << 8) | data[2];
          return raw / 1000.0;
        }
        return NaN;
      }
      
      function adjustWeight(diff) {
        const input = document.getElementById("Hal_Suly");
        let current = parseFloat(input.value) || 0;
        current += diff;
        input.value = current.toFixed(2);
        updateSulyKulonbseg?.(); // ha l√©tezik
      }
      
      // Tare listagener√°l√°s
      const tareSelect = document.getElementById("tareWeightSelect");
      for (let w = 0.7; w <= 3.5; w += 0.01) {
        let option = document.createElement("option");
        option.value = option.text = w.toFixed(2);
        tareSelect.add(option);
      }

      // Kor√°bban kiv√°lasztott √©rt√©k visszat√∂lt√©se
      const savedTareWeight = localStorage.getItem("tareWeight");
      if (savedTareWeight) {
        tareSelect.value = savedTareWeight;
      }

      document.getElementById("tareCheckbox").addEventListener("change", function () {
        tareSelect.style.display = this.checked ? "block" : "none";
      });

      tareSelect.addEventListener("change", function () {
        localStorage.setItem("tareWeight", this.value);
      });

      function saveData() {
        const saveButton = document.getElementById("saveButton");
        saveButton.disabled = true;

        const chipNumber = document.getElementById("chipNumber").value.trim();
        let fishWeight = parseFloat(document.getElementById("fishWeight").value);
        const anglerName = document.getElementById("anglerName").value.trim();
        const catchLocation = document.getElementById("catchLocation").value.trim();
        const useTare = document.getElementById("tareCheckbox").checked;

        if (!chipNumber || isNaN(fishWeight) || !anglerName || !catchLocation) {
          showMessage("üö´ Minden mez≈ët ki kell t√∂lteni!", "error");
          saveButton.disabled = false;
          return;
        }

        if (chipNumber.length < 6 || chipNumber.length > 15) {
          showMessage("üö´ A chip sz√°mnak 6 √©s 15 karakter k√∂z√∂ttinek kell lennie!", "error");
          saveButton.disabled = false;
          return;
        }

        if (useTare) {
          const tareWeight = parseFloat(tareSelect.value);
          if (!isNaN(tareWeight)) {
            fishWeight -= tareWeight;
          }
        }
        fishWeight = parseFloat(fishWeight.toFixed(2));

        google.script.run.withSuccessHandler(function(response) {
          if (response.message.includes("Nem tal√°lhat√≥")) {
            showMessage("üö´ " + response.message, "error");
          } else {
            let diffMsg = "";
            if (response.weightDifference !== null) {
              const diff = parseFloat(response.weightDifference);
              if (diff > 0) {
                diffMsg = ` üìà <span style="color:green;">+${diff.toFixed(2)} kg</span>`;
              } else if (diff < 0) {
                diffMsg = ` üìâ <span style="color:red;">${diff.toFixed(2)} kg</span>`;
              }
            }
            showMessage(response.message + "<br> S√∫ly k√ºl√∂nbs√©g:" + diffMsg, "success");
            clearForm();
          }
          saveButton.disabled = false;
        }).withFailureHandler(function(error) {
          showMessage("‚ö†Ô∏è Hiba t√∂rt√©nt: " + error.message, "error");
          saveButton.disabled = false;
        }).saveCatchData(chipNumber, fishWeight, anglerName, catchLocation);
      }

      function showMessage(text, type) {
        const messageDiv = document.getElementById("message");
        messageDiv.innerHTML = text;
        messageDiv.className = "message " + type;
      }

      function clearForm() {
        document.getElementById("chipNumber").value = "";
        document.getElementById("fishWeight").value = "";
        document.getElementById("anglerName").value = "";
        document.getElementById("catchLocation").value = "";
        document.getElementById("tareCheckbox").checked = false;
        tareSelect.style.display = "none";
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body {
        font-family: 'Arial', sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }
      .container {
        width: 100%;
        max-width: 450px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      h2 {
        text-align: center;
        color: #333;
      }
      input, button, select {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
      }
      button {
        background-color: #4CAF50;
        color: white;
        font-size: 16px;
        cursor: pointer;
      }
      button:hover {
        background-color: #45a049;
      }
      label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 12px;
        font-weight: bold;
        user-select: none;
      }
  
      label input[type="checkbox"] {
        margin-right: 10px;
        width: auto;
      }
      .message {
        margin-top: 20px;
        padding: 10px;
        border-radius: 8px;
        font-weight: bold;
        text-align: center;
      }
      .scaleOut {
        margin-top: 20px;
        padding: 10px;
        border-radius: 8px;
        font-weight: bold;
        text-align: center;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
      }
      .icon {
        font-size: 24px;
        vertical-align: middle;
        margin-right: 5px;
      }
      .options-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .options-row label {
        display: flex;
        align-items: center;
        font-size: 14px;
      }
      .options-row input {
        width: auto;
        margin-right: 5px;
      }
      #tareWeightSelect {
        display: none;
        margin: 5px 0 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>üé£ Fog√°s r√∂gz√≠t√©se üê†</h2>
      <input type="text" id="chipNumber" placeholder="#Ô∏è‚É£ Chip sz√°m (6‚Äì15 karakter)" pattern=".{6,15}" title="A chip sz√°mnak legal√°bb 6, legfeljebb 15 karakteresnek kell lennie" required>
      <input type="number" id="fishWeight" placeholder="‚öñÔ∏è Hal s√∫lya (kg)" step="0.1" min="5">
      <input type="text" id="anglerName" placeholder="üë§ Horg√°sz neve">
      <input type="text" id="catchLocation" placeholder="üìç Fog√°s helye">
      <button onclick="csatlakozas()">üîå Csatlakoz√°s a m√©rleghez</button>
      <div id="scaleOut"></div>
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 10px;">
        <label style="display: flex; align-items: center;">
          <input type="checkbox" id="tareCheckbox" style="margin-right: 5px;">
          M√©rlegl≈ëzs√°k visszam√©r√©se
        </label>
        <label style="display: flex; align-items: center;">
          <input type="checkbox" id="preciseCheckbox_m" style="margin-right: 5px;">
          -0.05 kg
        </label>        
        <label style="display: flex; align-items: center;">
          <input type="checkbox" id="preciseCheckbox_p" style="margin-right: 5px;">
          +0.05 kg
        </label>
      </div>
      <select id="tareWeightSelect"></select>
      <button id="saveButton" onclick="saveData()">üíæ Ment√©s</button>
      <div id="message"></div>
    </div>
    
    <script type="module">
      import { WHC06 } from 'https://unpkg.com/@hangtime/grip-connect@latest?module';

      const output = document.getElementById("scaleOut");
      const weight = document.getElementById("fishWeight");
      const preciseCheckbox_m = document.getElementById("preciseCheckbox_m");
      const preciseCheckbox_p = document.getElementById("preciseCheckbox_p");
      scaleOut.style.display = "none";
      let device;
      let utolsoAdat = null;
      
      function showMessage(text, type) {
        const messageDiv = document.getElementById("message");
        messageDiv.innerHTML = text;
        messageDiv.className = "message " + type;
      }
      
      async function csatlakozas() {
        try {
          device = new WHC06();
          await device.connect();
  
          output.className = "message success";
          output.textContent = "‚úÖ Csatlakoz√°s sikeres, v√°rakoz√°s m√©r√©sre...";
          saveButton.disabled = false;
          weight.style.display = "none";
          scaleOut.style.display = "";

          
          device.notify((data) => {
            console.log("Kapott adat:", data);
            utolsoAdat = data;
  
            const raw = parseFloat(data.massTotal);
            if (!isNaN(raw)) {
              const formatted = `${raw.toFixed(2)} kg`;
              output.textContent = `‚öñÔ∏è S√∫ly: ${formatted}`;
            } else {
              output.textContent = "‚öñÔ∏è S√∫ly: √ârv√©nytelen adat";
            }
          });
  
        } catch (err) {
          console.error(err);
          output.className = "message error";
          output.textContent = `‚ùå Hiba: ${err.message}`;
          saveButton.disabled = true;
        }
      }

      // Tare listagener√°l√°s
      const tareSelect = document.getElementById("tareWeightSelect");
      for (let w = 0.7; w <= 3.5; w += 0.01) {
        let option = document.createElement("option");
        option.value = option.text = w.toFixed(2);
        tareSelect.add(option);
      }

      // Kor√°bban kiv√°lasztott √©rt√©k visszat√∂lt√©se
      const savedTareWeight = localStorage.getItem("tareWeight");
      if (savedTareWeight) {
        tareSelect.value = savedTareWeight;
      }

      document.getElementById("tareCheckbox").addEventListener("change", function () {
        tareSelect.style.display = this.checked ? "block" : "none";
      });

      tareSelect.addEventListener("change", function () {
        localStorage.setItem("tareWeight", this.value);
      });

      function saveData() {
        const saveButton = document.getElementById("saveButton");
        saveButton.disabled = true;
      
        const chipNumber = document.getElementById("chipNumber").value.trim();
        const anglerName = document.getElementById("anglerName").value.trim();
        const catchLocation = document.getElementById("catchLocation").value.trim();
        const useTare = document.getElementById("tareCheckbox").checked;
      
        let fishWeight;
      
        if (device && utolsoAdat) {
          // M√©rleggel m√©r√ºnk: fishWeight legyen a m√©rlegb≈ël j√∂v≈ë adat
          fishWeight = parseFloat(utolsoAdat.massTotal);
          if (isNaN(fishWeight)) {
            showMessage("üö´ √ârv√©nytelen m√©rleg adat!", "error");
            saveButton.disabled = false;
            return;
          }
        } else {
          // Nincs m√©rleg: k√©zi inputb√≥l vessz√ºk a fishWeight-et
          const fishWeightInput = document.getElementById("fishWeight").value;
          fishWeight = parseFloat(fishWeightInput);
          if (isNaN(fishWeight)) {
            showMessage("üö´ A hal s√∫ly√°t meg kell adni!", "error");
            saveButton.disabled = false;
            return;
          }
        }
      
        if (!chipNumber || !anglerName || !catchLocation) {
          showMessage("üö´ Minden mez≈ët ki kell t√∂lteni!", "error");
          saveButton.disabled = false;
          return;
        }
      
        if (chipNumber.length < 6 || chipNumber.length > 15) {
          showMessage("üö´ A chip sz√°mnak 6 √©s 15 karakter k√∂z√∂ttinek kell lennie!", "error");
          saveButton.disabled = false;
          return;
        }
      
        if (useTare) {
          const tareWeight = parseFloat(tareSelect.value);
          if (!isNaN(tareWeight)) {
            fishWeight -= tareWeight;
          }
        }
        if (preciseCheckbox_m.checked) {
          fishWeight -= 0.05;
        }
        if (preciseCheckbox_p.checked) {
          fishWeight += 0.05;
        }
      
        fishWeight = parseFloat(fishWeight.toFixed(2));
            
        const data = {
          chipNumber,
          fishWeight,
          anglerName,
          catchLocation
        };
        
        fetch('https://catchproxy.pallagi-bela.workers.dev', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        })
        .then(res => res.json())
        .then(response => {
          if (response.message && response.message.includes("Nem tal√°lhat√≥")) {
            showMessage("üö´ " + response.message, "error");
          } else {
            let diffMsg = "";
            if (response.weightDifference !== null && response.weightDifference !== undefined) {
              const diff = parseFloat(response.weightDifference);
              if (diff > 0) {
                diffMsg = ` üìà <span style="color:green;">+${diff.toFixed(2)} kg</span>`;
              } else if (diff < 0) {
                diffMsg = ` üìâ <span style="color:red;">${diff.toFixed(2)} kg</span>`;
              }
            }
            showMessage((response.message || "‚úÖ Ment√©s sikeres") + "<br> S√∫ly k√ºl√∂nbs√©g:" + diffMsg, "success");
            clearForm();
          }
        })
        .catch(error => {
          showMessage("‚ö†Ô∏è Hiba t√∂rt√©nt: " + error.message, "error");
        })
        .finally(() => {
          saveButton.disabled = false;
        });
      }

      function clearForm() {
        document.getElementById("chipNumber").value = "";
        document.getElementById("fishWeight").value = "";
        document.getElementById("anglerName").value = "";
        document.getElementById("catchLocation").value = "";
        document.getElementById("tareCheckbox").checked = false;
        tareSelect.style.display = "none";
      }
      
      window.csatlakozas = csatlakozas;
      window.saveData = saveData;
    </script>
  </body>
</html>

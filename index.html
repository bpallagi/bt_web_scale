<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WH-C06 Mérleg Integráció</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f2f2f2;
      color: #333;
    }
    .container {
      max-width: 450px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    h2 {
      margin-bottom: 15px;
    }
    button {
      font-size: 16px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      margin-top: 15px;
      width: 100%;
    }
    button:hover {
      background-color: #45a049;
    }
    #massValue {
      font-size: 48px;
      font-weight: bold;
      margin-top: 25px;
    }
    #debugMassData {
      font-size: 14px;
      color: #555;
      margin-top: 10px;
      text-align: left;
      white-space: pre-line;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
      color: #d35400;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>WH-C06 Mérleg Integráció</h2>
    <button id="connectBtn">Bluetooth kapcsolat</button>
    <div id="status"></div>
    <div id="massValue">-- kg</div>
    <div id="debugMassData"></div>
  </div>

  <script>
    const connectBtn = document.getElementById('connectBtn');
    const statusDiv = document.getElementById('status');
    const massValueDiv = document.getElementById('massValue');
    const debugDiv = document.getElementById('debugMassData');

    let device;
    let server;
    let characteristic;

    // A WH-C06 mérleg szolgáltatása és karakterisztikája (ezeket állítsd be, ha szükséges)
    const serviceUUID = 0x181D; // Weight Scale service UUID (standard)
    const characteristicUUID = 0x2A9D; // Weight Measurement characteristic UUID (standard)

    connectBtn.addEventListener('click', async () => {
      statusDiv.textContent = "Kapcsolódás folyamatban...";
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [serviceUUID] }]
          // Ha nincs filter, lehet acceptAllDevices: true és manuális szűrés is
        });
        device.addEventListener('gattserverdisconnected', onDisconnected);

        server = await device.gatt.connect();

        const service = await server.getPrimaryService(serviceUUID);
        characteristic = await service.getCharacteristic(characteristicUUID);

        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', handleMeasurement);

        statusDiv.textContent = "Csatlakozva és mérés fogadása indul.";
      } catch (error) {
        statusDiv.textContent = "Hiba a kapcsolódás során: " + error;
      }
    });

    function onDisconnected() {
      statusDiv.textContent = "A mérleg lecsatlakozott.";
      massValueDiv.textContent = "-- kg";
      debugDiv.textContent = "";
    }

    function handleMeasurement(event) {
      const value = event.target.value;
      // Ez egy DataView, be kell olvasni a súlyadatokat
      // A WH-C06 eszköz adatszerkezete eltérhet, itt egy alap példa:

      // Példa: az első byte a flags, utána 2 byte súly 0.005kg lépésben, stb.
      // Ez konkrétan az official Weight Scale characteristic formátuma:
      // https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.weight_measurement.xml
      const flags = value.getUint8(0);
      let index = 1;
      let weightKg;

      // Ha 0.005kg a lépés és kg a mértékegység
      if ((flags & 0x01) === 0) {
        // SI units (kg)
        const weightRaw = value.getUint16(index, /*littleEndian=*/true);
        weightKg = weightRaw * 0.005;
      } else {
        // Imperial units (lb)
        const weightRaw = value.getUint16(index, /*littleEndian=*/true);
        weightKg = weightRaw * 0.01 / 2.20462;
      }

      showMass(weightKg);
    }

    function showMass(massKg) {
      massValueDiv.textContent = massKg.toFixed(2) + " kg";

      debugDiv.textContent =
        `Mért tömeg (kg): ${massKg}\n` +
        `Raw adat: ${characteristic ? characteristic.value : 'N/A'}`;
    }
  </script>
</body>
</html>
